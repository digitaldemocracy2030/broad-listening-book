#!/usr/bin/env python3
"""
都道府県データを使ったUMAP次元圧縮の例

「統計でみる都道府県のすがた2024」のデータを使用して、
47都道府県を多次元の統計指標からUMAPで2次元に圧縮し可視化します。

データ出典: 総務省統計局「統計でみる都道府県のすがた2024」
https://www.e-stat.go.jp/stat-search/files?toukei=00200502&tstat=000001213120
"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib import rcParams
from pathlib import Path
import urllib.request
import io

# 日本語フォント設定
rcParams['font.family'] = 'sans-serif'
rcParams['font.sans-serif'] = ['Hiragino Sans', 'Yu Gothic', 'Meiryo', 'MS Gothic', 'Noto Sans CJK JP']

# 出力ディレクトリ
OUTPUT_DIR = Path(__file__).parent.parent / "images"
OUTPUT_DIR.mkdir(exist_ok=True)

# データディレクトリ
DATA_DIR = Path(__file__).parent.parent / "data"
DATA_DIR.mkdir(exist_ok=True)

# 都道府県名
PREFECTURES = [
    "北海道", "青森県", "岩手県", "宮城県", "秋田県", "山形県", "福島県",
    "茨城県", "栃木県", "群馬県", "埼玉県", "千葉県", "東京都", "神奈川県",
    "新潟県", "富山県", "石川県", "福井県", "山梨県", "長野県", "岐阜県",
    "静岡県", "愛知県", "三重県", "滋賀県", "京都府", "大阪府", "兵庫県",
    "奈良県", "和歌山県", "鳥取県", "島根県", "岡山県", "広島県", "山口県",
    "徳島県", "香川県", "愛媛県", "高知県", "福岡県", "佐賀県", "長崎県",
    "熊本県", "大分県", "宮崎県", "鹿児島県", "沖縄県"
]

# 地方区分（可視化用）
REGIONS = {
    "北海道": "北海道",
    "青森県": "東北", "岩手県": "東北", "宮城県": "東北", "秋田県": "東北", "山形県": "東北", "福島県": "東北",
    "茨城県": "関東", "栃木県": "関東", "群馬県": "関東", "埼玉県": "関東", "千葉県": "関東", "東京都": "関東", "神奈川県": "関東",
    "新潟県": "中部", "富山県": "中部", "石川県": "中部", "福井県": "中部", "山梨県": "中部", "長野県": "中部", "岐阜県": "中部", "静岡県": "中部", "愛知県": "中部",
    "三重県": "近畿", "滋賀県": "近畿", "京都府": "近畿", "大阪府": "近畿", "兵庫県": "近畿", "奈良県": "近畿", "和歌山県": "近畿",
    "鳥取県": "中国", "島根県": "中国", "岡山県": "中国", "広島県": "中国", "山口県": "中国",
    "徳島県": "四国", "香川県": "四国", "愛媛県": "四国", "高知県": "四国",
    "福岡県": "九州", "佐賀県": "九州", "長崎県": "九州", "熊本県": "九州", "大分県": "九州", "宮崎県": "九州", "鹿児島県": "九州", "沖縄県": "九州",
}

REGION_COLORS = {
    "北海道": "#1f77b4",
    "東北": "#ff7f0e",
    "関東": "#2ca02c",
    "中部": "#d62728",
    "近畿": "#9467bd",
    "中国": "#8c564b",
    "四国": "#e377c2",
    "九州": "#7f7f7f",
}

REGION_MARKERS = {
    "北海道": "o",
    "東北": "s",
    "関東": "^",
    "中部": "D",
    "近畿": "v",
    "中国": "p",
    "四国": "h",
    "九州": "*",
}


def download_estat_data():
    """
    e-Statから「統計でみる都道府県のすがた2024」のデータをダウンロード

    注意: e-StatのAPIを使用する場合はAPI keyが必要です。
    ここでは手動でダウンロードしたExcelファイルを使用する想定です。
    """
    # e-Statの直接ダウンロードURLの例（実際のURLは変わる可能性があります）
    # 手動でダウンロードする場合は以下のURLにアクセス:
    # https://www.e-stat.go.jp/stat-search/files?toukei=00200502&tstat=000001213120

    excel_path = DATA_DIR / "prefectures_2024.xlsx"

    if not excel_path.exists():
        print(f"データファイルが見つかりません: {excel_path}")
        print("以下の手順でデータを取得してください:")
        print("1. https://www.e-stat.go.jp/stat-search/files?toukei=00200502&tstat=000001213120 にアクセス")
        print("2. 「社会生活統計指標」のExcelファイルをダウンロード")
        print(f"3. {excel_path} として保存")
        return None

    return excel_path


def create_sample_data():
    """
    サンプルデータを作成（実際のデータがない場合のテスト用）

    約50指標のサンプルデータを生成します。
    実際の分析では e-Stat からダウンロードした実データを使用してください。
    """
    np.random.seed(42)

    # 都道府県の特性プロファイル
    # カテゴリ: 大都市, 工業県, 農業県, 高齢化県, ベッドタウン, 観光県, その他
    profiles = {
        # 大都市圏
        "東京都": "大都市",
        "大阪府": "大都市",
        "神奈川県": "大都市",
        "愛知県": "工業都市",
        "福岡県": "地方中核",
        # 工業県
        "静岡県": "工業県",
        "群馬県": "工業県",
        "栃木県": "工業県",
        "三重県": "工業県",
        "滋賀県": "工業県",
        "広島県": "工業県",
        # 農業県
        "北海道": "農業県",
        "鹿児島県": "農業県",
        "宮崎県": "農業県",
        "熊本県": "農業県",
        "青森県": "農業県",
        "岩手県": "農業県",
        "新潟県": "農業県",
        # 高齢化県
        "秋田県": "高齢化県",
        "高知県": "高齢化県",
        "島根県": "高齢化県",
        "和歌山県": "高齢化県",
        "山口県": "高齢化県",
        "徳島県": "高齢化県",
        # ベッドタウン
        "埼玉県": "ベッドタウン",
        "千葉県": "ベッドタウン",
        "兵庫県": "ベッドタウン",
        "奈良県": "ベッドタウン",
        # 観光県
        "京都府": "観光県",
        "沖縄県": "観光県",
        "長野県": "観光県",
        "山梨県": "観光県",
    }

    # 各プロファイルの基本パラメータ
    base_params = {
        "大都市": {
            "第1次産業比率": (0.3, 0.2), "第2次産業比率": (18, 3), "第3次産業比率": (82, 3),
            "高齢化率": (23, 2), "年少人口比率": (12, 1), "生産年齢人口比率": (65, 2),
            "人口密度": (5000, 2000), "DID人口比率": (90, 5), "人口増減率": (0.3, 0.3),
            "出生率": (7.5, 0.5), "死亡率": (8.5, 0.5), "婚姻率": (5.5, 0.3),
            "1人当たり所得": (380, 40), "完全失業率": (3.0, 0.3), "有効求人倍率": (1.4, 0.2),
            "大卒比率": (35, 5), "高校進学率": (98, 1), "大学進学率": (65, 5),
            "病床数": (10, 2), "医師数": (280, 30), "平均寿命男": (81, 0.5), "平均寿命女": (87, 0.5),
            "持家比率": (45, 5), "1人当たり住宅面積": (65, 10), "自動車保有率": (0.4, 0.1),
            "小売販売額": (150, 20), "製造品出荷額": (50, 20), "農業産出額": (5, 3),
            "観光客数": (8000, 2000), "宿泊施設数": (500, 100),
            "財政力指数": (0.9, 0.1), "公債費比率": (12, 2),
            "刑法犯認知件数": (800, 100), "交通事故件数": (400, 50),
            "平均気温": (16, 1), "日照時間": (1900, 100), "降水量": (1500, 200),
            "森林率": (35, 10), "耕地面積比率": (8, 3),
            "インターネット普及率": (88, 3), "スマホ保有率": (85, 3),
            "共働き率": (48, 3), "女性労働力率": (52, 3),
            "保育所数": (2000, 500), "待機児童率": (1.5, 0.5),
            "図書館数": (300, 50), "博物館数": (80, 20),
        },
        "工業都市": {
            "第1次産業比率": (1.0, 0.5), "第2次産業比率": (35, 5), "第3次産業比率": (64, 5),
            "高齢化率": (25, 2), "年少人口比率": (13, 1), "生産年齢人口比率": (62, 2),
            "人口密度": (1500, 500), "DID人口比率": (70, 10), "人口増減率": (0.0, 0.2),
            "出生率": (8.0, 0.5), "死亡率": (9.0, 0.5), "婚姻率": (5.0, 0.3),
            "1人当たり所得": (340, 30), "完全失業率": (2.5, 0.3), "有効求人倍率": (1.6, 0.2),
            "大卒比率": (25, 5), "高校進学率": (97, 1), "大学進学率": (55, 5),
            "病床数": (11, 2), "医師数": (220, 30), "平均寿命男": (81, 0.5), "平均寿命女": (87, 0.5),
            "持家比率": (65, 5), "1人当たり住宅面積": (95, 10), "自動車保有率": (1.2, 0.2),
            "小売販売額": (100, 15), "製造品出荷額": (450, 100), "農業産出額": (30, 15),
            "観光客数": (3000, 1000), "宿泊施設数": (200, 50),
            "財政力指数": (0.85, 0.1), "公債費比率": (10, 2),
            "刑法犯認知件数": (500, 80), "交通事故件数": (350, 50),
            "平均気温": (16, 1), "日照時間": (2100, 100), "降水量": (1600, 200),
            "森林率": (45, 10), "耕地面積比率": (12, 5),
            "インターネット普及率": (82, 3), "スマホ保有率": (78, 3),
            "共働き率": (55, 3), "女性労働力率": (50, 3),
            "保育所数": (800, 200), "待機児童率": (0.8, 0.3),
            "図書館数": (100, 30), "博物館数": (30, 10),
        },
        "工業県": {
            "第1次産業比率": (2.5, 1), "第2次産業比率": (38, 5), "第3次産業比率": (60, 5),
            "高齢化率": (28, 2), "年少人口比率": (12, 1), "生産年齢人口比率": (60, 2),
            "人口密度": (500, 200), "DID人口比率": (50, 10), "人口増減率": (-0.3, 0.2),
            "出生率": (7.5, 0.5), "死亡率": (10, 0.5), "婚姻率": (4.5, 0.3),
            "1人当たり所得": (310, 25), "完全失業率": (2.8, 0.3), "有効求人倍率": (1.4, 0.2),
            "大卒比率": (20, 5), "高校進学率": (96, 1), "大学進学率": (48, 5),
            "病床数": (12, 2), "医師数": (200, 30), "平均寿命男": (80, 0.5), "平均寿命女": (87, 0.5),
            "持家比率": (72, 5), "1人当たり住宅面積": (105, 10), "自動車保有率": (1.5, 0.2),
            "小売販売額": (80, 15), "製造品出荷額": (350, 80), "農業産出額": (50, 20),
            "観光客数": (2000, 800), "宿泊施設数": (150, 50),
            "財政力指数": (0.6, 0.1), "公債費比率": (13, 2),
            "刑法犯認知件数": (350, 60), "交通事故件数": (280, 40),
            "平均気温": (15, 2), "日照時間": (2000, 150), "降水量": (1400, 300),
            "森林率": (55, 10), "耕地面積比率": (15, 5),
            "インターネット普及率": (78, 3), "スマホ保有率": (72, 3),
            "共働き率": (58, 3), "女性労働力率": (48, 3),
            "保育所数": (400, 100), "待機児童率": (0.3, 0.2),
            "図書館数": (60, 20), "博物館数": (20, 8),
        },
        "農業県": {
            "第1次産業比率": (8, 3), "第2次産業比率": (22, 5), "第3次産業比率": (70, 5),
            "高齢化率": (32, 2), "年少人口比率": (11, 1), "生産年齢人口比率": (57, 2),
            "人口密度": (150, 80), "DID人口比率": (35, 10), "人口増減率": (-0.8, 0.2),
            "出生率": (7.0, 0.5), "死亡率": (12, 0.5), "婚姻率": (4.0, 0.3),
            "1人当たり所得": (260, 20), "完全失業率": (3.2, 0.3), "有効求人倍率": (1.1, 0.2),
            "大卒比率": (15, 4), "高校進学率": (95, 1), "大学進学率": (42, 5),
            "病床数": (14, 2), "医師数": (190, 30), "平均寿命男": (80, 0.5), "平均寿命女": (87, 0.5),
            "持家比率": (78, 5), "1人当たり住宅面積": (120, 15), "自動車保有率": (1.6, 0.2),
            "小売販売額": (60, 15), "製造品出荷額": (80, 40), "農業産出額": (250, 80),
            "観光客数": (2500, 1000), "宿泊施設数": (180, 60),
            "財政力指数": (0.35, 0.1), "公債費比率": (15, 2),
            "刑法犯認知件数": (250, 50), "交通事故件数": (200, 40),
            "平均気温": (13, 3), "日照時間": (1800, 200), "降水量": (1300, 400),
            "森林率": (65, 10), "耕地面積比率": (20, 8),
            "インターネット普及率": (72, 4), "スマホ保有率": (65, 4),
            "共働き率": (55, 4), "女性労働力率": (50, 4),
            "保育所数": (250, 80), "待機児童率": (0.1, 0.1),
            "図書館数": (50, 15), "博物館数": (15, 5),
        },
        "高齢化県": {
            "第1次産業比率": (6, 2), "第2次産業比率": (20, 5), "第3次産業比率": (74, 5),
            "高齢化率": (36, 2), "年少人口比率": (10, 1), "生産年齢人口比率": (54, 2),
            "人口密度": (120, 60), "DID人口比率": (30, 10), "人口増減率": (-1.2, 0.2),
            "出生率": (6.0, 0.5), "死亡率": (14, 0.5), "婚姻率": (3.5, 0.3),
            "1人当たり所得": (240, 20), "完全失業率": (3.5, 0.3), "有効求人倍率": (1.0, 0.2),
            "大卒比率": (12, 4), "高校進学率": (94, 1), "大学進学率": (38, 5),
            "病床数": (16, 2), "医師数": (210, 40), "平均寿命男": (80, 0.5), "平均寿命女": (87, 0.5),
            "持家比率": (80, 5), "1人当たり住宅面積": (130, 15), "自動車保有率": (1.4, 0.2),
            "小売販売額": (50, 12), "製造品出荷額": (60, 30), "農業産出額": (120, 50),
            "観光客数": (1500, 600), "宿泊施設数": (120, 40),
            "財政力指数": (0.25, 0.08), "公債費比率": (17, 2),
            "刑法犯認知件数": (180, 40), "交通事故件数": (150, 30),
            "平均気温": (14, 2), "日照時間": (1850, 150), "降水量": (1600, 400),
            "森林率": (75, 8), "耕地面積比率": (12, 5),
            "インターネット普及率": (68, 4), "スマホ保有率": (60, 5),
            "共働き率": (52, 4), "女性労働力率": (48, 4),
            "保育所数": (150, 50), "待機児童率": (0.0, 0.05),
            "図書館数": (35, 12), "博物館数": (12, 5),
        },
        "ベッドタウン": {
            "第1次産業比率": (1.2, 0.5), "第2次産業比率": (22, 5), "第3次産業比率": (77, 5),
            "高齢化率": (26, 2), "年少人口比率": (12, 1), "生産年齢人口比率": (62, 2),
            "人口密度": (2000, 800), "DID人口比率": (75, 10), "人口増減率": (-0.1, 0.2),
            "出生率": (7.8, 0.5), "死亡率": (8.5, 0.5), "婚姻率": (4.8, 0.3),
            "1人当たり所得": (300, 25), "完全失業率": (3.0, 0.3), "有効求人倍率": (1.2, 0.2),
            "大卒比率": (28, 5), "高校進学率": (97, 1), "大学進学率": (58, 5),
            "病床数": (10, 2), "医師数": (200, 30), "平均寿命男": (81, 0.5), "平均寿命女": (87, 0.5),
            "持家比率": (62, 5), "1人当たり住宅面積": (85, 10), "自動車保有率": (0.8, 0.2),
            "小売販売額": (90, 15), "製造品出荷額": (100, 40), "農業産出額": (40, 20),
            "観光客数": (2000, 800), "宿泊施設数": (150, 50),
            "財政力指数": (0.7, 0.1), "公債費比率": (11, 2),
            "刑法犯認知件数": (450, 70), "交通事故件数": (320, 50),
            "平均気温": (16, 1), "日照時間": (2000, 100), "降水量": (1400, 200),
            "森林率": (40, 10), "耕地面積比率": (12, 5),
            "インターネット普及率": (84, 3), "スマホ保有率": (80, 3),
            "共働き率": (50, 3), "女性労働力率": (50, 3),
            "保育所数": (600, 150), "待機児童率": (1.0, 0.4),
            "図書館数": (80, 25), "博物館数": (25, 10),
        },
        "観光県": {
            "第1次産業比率": (3, 1.5), "第2次産業比率": (20, 5), "第3次産業比率": (77, 5),
            "高齢化率": (29, 3), "年少人口比率": (12, 1), "生産年齢人口比率": (59, 2),
            "人口密度": (300, 150), "DID人口比率": (45, 15), "人口増減率": (-0.4, 0.3),
            "出生率": (7.5, 0.5), "死亡率": (10, 0.5), "婚姻率": (4.5, 0.3),
            "1人当たり所得": (290, 25), "完全失業率": (3.0, 0.3), "有効求人倍率": (1.2, 0.2),
            "大卒比率": (22, 5), "高校進学率": (96, 1), "大学進学率": (52, 5),
            "病床数": (12, 2), "医師数": (230, 40), "平均寿命男": (81, 0.5), "平均寿命女": (87, 0.5),
            "持家比率": (68, 5), "1人当たり住宅面積": (100, 12), "自動車保有率": (1.2, 0.2),
            "小売販売額": (75, 15), "製造品出荷額": (80, 40), "農業産出額": (80, 40),
            "観光客数": (6000, 2000), "宿泊施設数": (400, 100),
            "財政力指数": (0.5, 0.15), "公債費比率": (13, 2),
            "刑法犯認知件数": (300, 60), "交通事故件数": (220, 40),
            "平均気温": (15, 3), "日照時間": (1950, 150), "降水量": (1500, 400),
            "森林率": (70, 10), "耕地面積比率": (10, 5),
            "インターネット普及率": (76, 4), "スマホ保有率": (72, 4),
            "共働き率": (52, 4), "女性労働力率": (50, 4),
            "保育所数": (300, 100), "待機児童率": (0.2, 0.15),
            "図書館数": (55, 18), "博物館数": (35, 15),
        },
        "地方中核": {
            "第1次産業比率": (2, 1), "第2次産業比率": (20, 5), "第3次産業比率": (78, 5),
            "高齢化率": (27, 2), "年少人口比率": (13, 1), "生産年齢人口比率": (60, 2),
            "人口密度": (1000, 400), "DID人口比率": (65, 10), "人口増減率": (0.0, 0.2),
            "出生率": (8.0, 0.5), "死亡率": (9.5, 0.5), "婚姻率": (5.0, 0.3),
            "1人当たり所得": (300, 25), "完全失業率": (3.2, 0.3), "有効求人倍率": (1.2, 0.2),
            "大卒比率": (25, 5), "高校進学率": (96, 1), "大学進学率": (52, 5),
            "病床数": (13, 2), "医師数": (250, 30), "平均寿命男": (80, 0.5), "平均寿命女": (87, 0.5),
            "持家比率": (58, 5), "1人当たり住宅面積": (90, 10), "自動車保有率": (1.0, 0.2),
            "小売販売額": (100, 15), "製造品出荷額": (100, 40), "農業産出額": (50, 25),
            "観光客数": (4000, 1500), "宿泊施設数": (300, 80),
            "財政力指数": (0.65, 0.1), "公債費比率": (12, 2),
            "刑法犯認知件数": (550, 80), "交通事故件数": (350, 50),
            "平均気温": (17, 1), "日照時間": (1900, 100), "降水量": (1700, 200),
            "森林率": (45, 10), "耕地面積比率": (12, 5),
            "インターネット普及率": (80, 3), "スマホ保有率": (76, 3),
            "共働き率": (50, 3), "女性労働力率": (50, 3),
            "保育所数": (500, 120), "待機児童率": (0.5, 0.3),
            "図書館数": (70, 20), "博物館数": (30, 10),
        },
        "その他": {
            "第1次産業比率": (4, 2), "第2次産業比率": (25, 6), "第3次産業比率": (71, 6),
            "高齢化率": (30, 3), "年少人口比率": (11, 1), "生産年齢人口比率": (59, 2),
            "人口密度": (350, 200), "DID人口比率": (45, 15), "人口増減率": (-0.5, 0.3),
            "出生率": (7.2, 0.5), "死亡率": (11, 0.5), "婚姻率": (4.2, 0.3),
            "1人当たり所得": (275, 25), "完全失業率": (3.0, 0.3), "有効求人倍率": (1.15, 0.2),
            "大卒比率": (18, 5), "高校進学率": (96, 1), "大学進学率": (48, 5),
            "病床数": (13, 2), "医師数": (210, 35), "平均寿命男": (80, 0.5), "平均寿命女": (87, 0.5),
            "持家比率": (70, 6), "1人当たり住宅面積": (105, 12), "自動車保有率": (1.3, 0.2),
            "小売販売額": (70, 15), "製造品出荷額": (150, 70), "農業産出額": (100, 50),
            "観光客数": (2500, 1200), "宿泊施設数": (180, 70),
            "財政力指数": (0.45, 0.12), "公債費比率": (14, 2),
            "刑法犯認知件数": (300, 60), "交通事故件数": (250, 45),
            "平均気温": (15, 2), "日照時間": (1900, 150), "降水量": (1500, 350),
            "森林率": (60, 12), "耕地面積比率": (14, 6),
            "インターネット普及率": (75, 4), "スマホ保有率": (70, 4),
            "共働き率": (54, 4), "女性労働力率": (49, 4),
            "保育所数": (300, 100), "待機児童率": (0.2, 0.15),
            "図書館数": (50, 18), "博物館数": (18, 8),
        },
    }

    data = {}

    for pref in PREFECTURES:
        profile = profiles.get(pref, "その他")
        params = base_params[profile]

        pref_data = {}
        for indicator, (mean, std) in params.items():
            value = mean + np.random.randn() * std
            # 値の範囲を適切に制限
            if "比率" in indicator or "率" in indicator:
                value = max(0, min(100, value))
            elif indicator in ["財政力指数"]:
                value = max(0.1, min(1.5, value))
            else:
                value = max(0, value)
            pref_data[indicator] = value

        data[pref] = pref_data

    df = pd.DataFrame(data).T
    df.index.name = "都道府県"

    print(f"生成した指標数: {len(df.columns)}")
    return df


def load_or_create_data():
    """
    データを読み込むか、サンプルデータを作成
    """
    excel_path = DATA_DIR / "prefectures_2024.xlsx"

    if excel_path.exists():
        print(f"実データを読み込み中: {excel_path}")
        # 実際のExcelファイルの形式に合わせて読み込み処理を調整する必要があります
        try:
            df = pd.read_excel(excel_path, index_col=0)
            print(f"読み込み完了: {len(df)} 都道府県, {len(df.columns)} 指標")
            return df
        except Exception as e:
            print(f"読み込みエラー: {e}")
            print("サンプルデータを使用します")

    print("サンプルデータを生成中...")
    return create_sample_data()


def run_umap(df, n_neighbors=15, min_dist=0.1, random_state=42):
    """
    UMAPで次元圧縮を実行
    """
    from umap import UMAP
    from sklearn.preprocessing import StandardScaler

    # 欠損値の処理
    df_clean = df.dropna(axis=1, how='any')  # 欠損のある列を削除
    print(f"使用する指標数: {len(df_clean.columns)}")

    # 標準化
    scaler = StandardScaler()
    X_scaled = scaler.fit_transform(df_clean.values)

    # UMAP
    umap_model = UMAP(
        n_components=2,
        n_neighbors=n_neighbors,
        min_dist=min_dist,
        random_state=random_state,
        metric='euclidean'
    )
    X_umap = umap_model.fit_transform(X_scaled)

    return X_umap, df_clean.columns.tolist()


def plot_umap_result(X_umap, prefectures, title="都道府県のUMAP可視化", filename="13_prefecture_umap.png"):
    """
    UMAP結果を可視化
    """
    fig, ax = plt.subplots(figsize=(12, 10))

    # 地方ごとにプロット
    for region in REGION_COLORS.keys():
        mask = [REGIONS[p] == region for p in prefectures]
        indices = [i for i, m in enumerate(mask) if m]

        if indices:
            ax.scatter(
                X_umap[indices, 0],
                X_umap[indices, 1],
                c=REGION_COLORS[region],
                marker=REGION_MARKERS[region],
                s=100,
                label=region,
                alpha=0.8,
                edgecolors='black',
                linewidths=0.5
            )

    # 都道府県名をラベル
    for i, pref in enumerate(prefectures):
        ax.annotate(
            pref,
            (X_umap[i, 0], X_umap[i, 1]),
            xytext=(5, -10),
            textcoords='offset points',
            fontsize=10,
            alpha=0.8
        )

    ax.set_xlabel('UMAP 1', fontsize=12)
    ax.set_ylabel('UMAP 2', fontsize=12)
    ax.set_title(title, fontsize=14)
    ax.legend(loc='lower right', fontsize=10)
    ax.grid(True, alpha=0.3)

    plt.tight_layout()
    plt.savefig(OUTPUT_DIR / filename, dpi=150, bbox_inches='tight')
    plt.close()
    print(f"Saved: {filename}")


def plot_comparison(X_umap, prefectures):
    """
    地理的配置とUMAP配置の比較図を作成
    """
    # 簡易的な緯度経度（概算）
    geo_coords = {
        "北海道": (43.0, 141.3), "青森県": (40.8, 140.7), "岩手県": (39.7, 141.1),
        "宮城県": (38.3, 140.9), "秋田県": (39.7, 140.1), "山形県": (38.2, 140.3),
        "福島県": (37.7, 140.5), "茨城県": (36.3, 140.4), "栃木県": (36.6, 139.9),
        "群馬県": (36.4, 139.1), "埼玉県": (35.9, 139.6), "千葉県": (35.6, 140.1),
        "東京都": (35.7, 139.7), "神奈川県": (35.4, 139.6), "新潟県": (37.9, 139.0),
        "富山県": (36.7, 137.2), "石川県": (36.6, 136.6), "福井県": (36.1, 136.2),
        "山梨県": (35.7, 138.6), "長野県": (36.7, 138.2), "岐阜県": (35.4, 136.8),
        "静岡県": (34.9, 138.4), "愛知県": (35.2, 137.0), "三重県": (34.7, 136.5),
        "滋賀県": (35.0, 136.0), "京都府": (35.0, 135.8), "大阪府": (34.7, 135.5),
        "兵庫県": (34.7, 135.2), "奈良県": (34.7, 135.8), "和歌山県": (34.2, 135.2),
        "鳥取県": (35.5, 134.2), "島根県": (35.5, 133.1), "岡山県": (34.7, 133.9),
        "広島県": (34.4, 132.5), "山口県": (34.2, 131.5), "徳島県": (34.1, 134.6),
        "香川県": (34.3, 134.0), "愛媛県": (33.8, 132.8), "高知県": (33.6, 133.5),
        "福岡県": (33.6, 130.4), "佐賀県": (33.2, 130.3), "長崎県": (32.7, 129.9),
        "熊本県": (32.8, 130.7), "大分県": (33.2, 131.6), "宮崎県": (31.9, 131.4),
        "鹿児島県": (31.6, 130.6), "沖縄県": (26.2, 127.7),
    }

    fig, axes = plt.subplots(1, 2, figsize=(16, 7))

    # 左: 地理的配置
    ax = axes[0]
    for region in REGION_COLORS.keys():
        mask = [REGIONS[p] == region for p in prefectures]
        indices = [i for i, m in enumerate(mask) if m]

        if indices:
            lons = [geo_coords[prefectures[i]][1] for i in indices]
            lats = [geo_coords[prefectures[i]][0] for i in indices]
            ax.scatter(
                lons, lats,
                c=REGION_COLORS[region],
                marker=REGION_MARKERS[region],
                s=100,
                label=region,
                alpha=0.8,
                edgecolors='black',
                linewidths=0.5
            )

    ax.set_xlabel('経度', fontsize=12)
    ax.set_ylabel('緯度', fontsize=12)
    ax.set_title('地理的配置', fontsize=14)
    ax.legend(loc='lower right', fontsize=9)
    ax.grid(True, alpha=0.3)

    # 右: UMAP配置
    ax = axes[1]
    for region in REGION_COLORS.keys():
        mask = [REGIONS[p] == region for p in prefectures]
        indices = [i for i, m in enumerate(mask) if m]

        if indices:
            ax.scatter(
                X_umap[indices, 0],
                X_umap[indices, 1],
                c=REGION_COLORS[region],
                marker=REGION_MARKERS[region],
                s=100,
                label=region,
                alpha=0.8,
                edgecolors='black',
                linewidths=0.5
            )

    # ラベル追加
    for i, pref in enumerate(prefectures):
        ax.annotate(
            pref,
            (X_umap[i, 0], X_umap[i, 1]),
            xytext=(5, -10),
            textcoords='offset points',
            fontsize=9,
            alpha=0.8
        )

    ax.set_xlabel('UMAP 1', fontsize=12)
    ax.set_ylabel('UMAP 2', fontsize=12)
    ax.set_title('統計指標による配置（UMAP）', fontsize=14)
    ax.legend(loc='lower right', fontsize=9)
    ax.grid(True, alpha=0.3)

    plt.suptitle('地理的位置と統計的類似性の比較', fontsize=16)
    plt.tight_layout()
    plt.savefig(OUTPUT_DIR / "13_prefecture_umap_comparison.png", dpi=150, bbox_inches='tight')
    plt.close()
    print(f"Saved: 13_prefecture_umap_comparison.png")


def main():
    """
    メイン処理
    """
    print("=" * 60)
    print("都道府県データのUMAP可視化")
    print("=" * 60)

    # データ読み込み
    df = load_or_create_data()
    print(f"\nデータ形状: {df.shape}")
    print(f"指標一覧:\n{df.columns.tolist()}")

    # UMAP実行
    print("\nUMAP実行中...")
    X_umap, used_features = run_umap(df)
    print(f"使用した指標: {used_features}")

    # 可視化
    print("\n可視化...")
    prefectures = df.index.tolist()

    # UMAP単体
    plot_umap_result(X_umap, prefectures)

    # 地理との比較
    plot_comparison(X_umap, prefectures)

    print("\n完了!")


if __name__ == "__main__":
    main()
